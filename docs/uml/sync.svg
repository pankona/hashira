<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1300px" preserveAspectRatio="none" style="width:782px;height:1300px;" version="1.1" viewBox="0 0 782 1300" width="782px" zoomAndPan="magnify"><defs><filter height="300%" id="fp3z9iwhsswbp" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="45" x2="45" y1="36" y2="1288"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="195" x2="195" y1="36" y2="1288"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="323.5" x2="323.5" y1="36" y2="1288"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="443" x2="443" y1="36" y2="1288"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="593" x2="593" y1="36" y2="1288"/><rect fill="#FEFECE" filter="url(#fp3z9iwhsswbp)" height="28" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="8" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="15" y="22.3184">client 1</text><rect fill="#FEFECE" filter="url(#fp3z9iwhsswbp)" height="28" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="158" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="165" y="22.3184">daemon 1</text><rect fill="#FEFECE" filter="url(#fp3z9iwhsswbp)" height="28" style="stroke: #A80036; stroke-width: 1.5;" width="77" x="283.5" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="290.5" y="22.3184">datastore</text><rect fill="#FEFECE" filter="url(#fp3z9iwhsswbp)" height="28" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="406" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="413" y="22.3184">daemon 2</text><rect fill="#FEFECE" filter="url(#fp3z9iwhsswbp)" height="28" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="556" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="563" y="22.3184">client 2</text><polygon fill="#FBFB77" filter="url(#fp3z9iwhsswbp)" points="200,51,200,74,403,74,403,61,393,51,200,51" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="51" y2="61"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="403" x2="393" y1="61" y2="61"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="206" y="67.4385">assume daemon 1 is offline</text><polygon fill="#A80036" points="183,98,193,102,183,106,187,102" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="45" x2="189" y1="102" y2="102"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="52" y="98.4385">command-1 (cached)</text><polygon fill="#A80036" points="183,125,193,129,183,133,187,129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="45" x2="189" y1="129" y2="129"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="52" y="125.4385">command-2 (cached)</text><polygon fill="#FBFB77" filter="url(#fp3z9iwhsswbp)" points="200,142,200,178,522,178,522,152,512,142,200,142" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="512" x2="512" y1="142" y2="152"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="522" x2="512" y1="152" y2="152"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="206" y="158.4385">assume daemon 1 is online,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="213" y="171.4385">then send all cached commands to datastore</text><polygon fill="#A80036" points="312,202,322,206,312,210,316,206" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="195" x2="318" y1="206" y2="206"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="202" y="202.4385">command-1</text><polygon fill="#A80036" points="312,229,322,233,312,237,316,233" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="195" x2="318" y1="233" y2="233"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="202" y="229.4385">command-2</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324" x2="366" y1="260" y2="260"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="366" y1="260" y2="273"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325" x2="366" y1="273" y2="273"/><polygon fill="#A80036" points="335,269,325,273,335,277,331,273" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="331" y="256.4385">apply command-1</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324" x2="366" y1="300" y2="300"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="366" y1="300" y2="313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325" x2="366" y1="313" y2="313"/><polygon fill="#A80036" points="335,309,325,313,335,317,331,313" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="331" y="296.4385">apply command-2</text><polygon fill="#FBFB77" filter="url(#fp3z9iwhsswbp)" points="448,326,448,349,651,349,651,336,641,326,448,326" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="641" x2="641" y1="326" y2="336"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="651" x2="641" y1="336" y2="336"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="454" y="342.4385">assume daemon 2 is offline</text><polygon fill="#A80036" points="454,373,444,377,454,381,450,377" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="448" x2="592" y1="377" y2="377"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="460" y="373.4385">command-3 (cached)</text><polygon fill="#A80036" points="454,400,444,404,454,408,450,404" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="448" x2="592" y1="404" y2="404"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="460" y="400.4385">command-4 (cached)</text><polygon fill="#FBFB77" filter="url(#fp3z9iwhsswbp)" points="448,417,448,453,770,453,770,427,760,417,448,417" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="760" x2="760" y1="417" y2="427"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="770" x2="760" y1="427" y2="427"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="454" y="433.4385">assume daemon 2 is online,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="461" y="446.4385">then send all cached commands to datastore</text><polygon fill="#A80036" points="335,477,325,481,335,485,331,481" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="442" y1="481" y2="481"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="341" y="477.4385">command-3</text><polygon fill="#A80036" points="335,504,325,508,335,512,331,508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="442" y1="508" y2="508"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="341" y="504.4385">command-4</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324" x2="366" y1="535" y2="535"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="366" y1="535" y2="548"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325" x2="366" y1="548" y2="548"/><polygon fill="#A80036" points="335,544,325,548,335,552,331,548" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="331" y="531.4385">apply command-3</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324" x2="366" y1="575" y2="575"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="366" y1="575" y2="588"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325" x2="366" y1="588" y2="588"/><polygon fill="#A80036" points="335,584,325,588,335,592,331,588" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="331" y="571.4385">apply command-4</text><polygon fill="#A80036" points="335,611,325,615,335,619,331,615" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="442" y1="615" y2="615"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="341" y="611.4385">sync(nil)</text><polygon fill="#FBFB77" filter="url(#fp3z9iwhsswbp)" points="329,628,329,677,651,677,651,638,641,628,329,628" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="641" x2="641" y1="628" y2="638"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="651" x2="641" y1="638" y2="638"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="335" y="644.4385">sync(nil) requests to retrieve all commands</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="342" y="657.4385">they are applied to datastore</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="342" y="670.4385">(may need paging)</text><polygon fill="#A80036" points="431,701,441,705,431,709,435,705" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324" x2="437" y1="705" y2="705"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="331" y="701.4385">command-1</text><polygon fill="#A80036" points="431,728,441,732,431,736,435,732" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324" x2="437" y1="732" y2="732"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="331" y="728.4385">command-2</text><polygon fill="#A80036" points="431,755,441,759,431,763,435,759" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324" x2="437" y1="759" y2="759"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="331" y="755.4385">command-3</text><polygon fill="#A80036" points="431,782,441,786,431,790,435,786" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324" x2="437" y1="786" y2="786"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="331" y="782.4385">command-4</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="443" x2="485" y1="813" y2="813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="485" x2="485" y1="813" y2="826"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="444" x2="485" y1="826" y2="826"/><polygon fill="#A80036" points="454,822,444,826,454,830,450,826" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="450" y="809.4385">apply command-1</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="443" x2="485" y1="853" y2="853"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="485" x2="485" y1="853" y2="866"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="444" x2="485" y1="866" y2="866"/><polygon fill="#A80036" points="454,862,444,866,454,870,450,866" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="450" y="849.4385">apply command-2</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="443" x2="485" y1="893" y2="893"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="485" x2="485" y1="893" y2="906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="444" x2="485" y1="906" y2="906"/><polygon fill="#A80036" points="454,902,444,906,454,910,450,906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="450" y="889.4385">apply command-3</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="443" x2="485" y1="933" y2="933"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="485" x2="485" y1="933" y2="946"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="444" x2="485" y1="946" y2="946"/><polygon fill="#A80036" points="454,942,444,946,454,950,450,946" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="450" y="929.4385">apply command-4</text><polygon fill="#A80036" points="312,969,322,973,312,977,316,973" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="195" x2="318" y1="973" y2="973"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="202" y="969.4385">sync(command-2)</text><polygon fill="#FBFB77" filter="url(#fp3z9iwhsswbp)" points="200,986,200,1022,410,1022,410,996,400,986,200,986" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="400" x2="400" y1="986" y2="996"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="410" x2="400" y1="996" y2="996"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="206" y="1002.4385">command-2 is latest command</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="213" y="1015.4385">which is sent by daemon 1</text><polygon fill="#FBFB77" filter="url(#fp3z9iwhsswbp)" points="329,1036,329,1085,686,1085,686,1046,676,1036,329,1036" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="676" x2="676" y1="1036" y2="1046"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="686" x2="676" y1="1046" y2="1046"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="335" y="1052.4385">sync(command-2) request to retrieve all commands</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="342" y="1065.4385">they are applied after command-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="342" y="1078.4385">(may need paging)</text><polygon fill="#FBFB77" filter="url(#fp3z9iwhsswbp)" points="329,1099,329,1135,679,1135,679,1109,669,1099,329,1099" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="669" x2="669" y1="1099" y2="1109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="679" x2="669" y1="1109" y2="1109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="335" y="1115.4385">if there are commands received after command-2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="342" y="1128.4385">send back them all</text><polygon fill="#A80036" points="206,1159,196,1163,206,1167,202,1163" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="200" x2="323" y1="1163" y2="1163"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="212" y="1159.4385">command-3</text><polygon fill="#A80036" points="206,1186,196,1190,206,1194,202,1190" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="200" x2="323" y1="1190" y2="1190"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="212" y="1186.4385">command-4</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="195" x2="237" y1="1217" y2="1217"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="237" y1="1217" y2="1230"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="196" x2="237" y1="1230" y2="1230"/><polygon fill="#A80036" points="206,1226,196,1230,206,1234,202,1230" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="202" y="1213.4385">apply command-3</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="195" x2="237" y1="1257" y2="1257"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="237" y1="1257" y2="1270"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="196" x2="237" y1="1270" y2="1270"/><polygon fill="#A80036" points="206,1266,196,1270,206,1274,202,1270" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="202" y="1253.4385">apply command-4</text><!--
@startuml

hide footbox

participant "client 1"  as c1
participant "daemon 1"  as d1
participant "datastore" as ds
participant "daemon 2"  as d2
participant "client 2"  as c2


note right of d1 : assume daemon 1 is offline
c1 -> d1 : command-1 (cached)
c1 -> d1 : command-2 (cached)

note right of d1 : assume daemon 1 is online,\n then send all cached commands to datastore
d1 -> ds : command-1
d1 -> ds : command-2

ds -> ds : apply command-1
ds -> ds : apply command-2

note right of d2 : assume daemon 2 is offline
d2 <- c2 : command-3 (cached)
d2 <- c2 : command-4 (cached)

note right of d2 : assume daemon 2 is online,\n then send all cached commands to datastore
ds <- d2 : command-3
ds <- d2 : command-4

ds -> ds : apply command-3
ds -> ds : apply command-4

ds <- d2 : sync(nil)
note right of ds: sync(nil) requests to retrieve all commands\n they are applied to datastore\n (may need paging)
ds -> d2 : command-1
ds -> d2 : command-2
ds -> d2 : command-3
ds -> d2 : command-4
d2 -> d2 : apply command-1
d2 -> d2 : apply command-2
d2 -> d2 : apply command-3
d2 -> d2 : apply command-4

d1 -> ds : sync(command-2)
note right of d1 : command-2 is latest command\n which is sent by daemon 1
note right of ds : sync(command-2) request to retrieve all commands\n they are applied after command-2\n (may need paging)
note right of ds : if there are commands received after command-2,\n send back them all
d1 <- ds : command-3
d1 <- ds : command-4
d1 -> d1 : apply command-3
d1 -> d1 : apply command-4

@enduml

PlantUML version 1.2017.14(Mon Jun 05 18:56:32 JST 2017)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_144-b01
Operating System: Linux
OS Version: 4.12.14-1-MANJARO
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>